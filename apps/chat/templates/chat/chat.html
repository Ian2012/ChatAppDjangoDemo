{% extends 'base.html' %}
{% block title %}
	Login |
{% endblock %}
{% block content %}
	<h1>Welcome!</h1>
	<hr>
	<div id="chatapp">
		<h2>Chat</h2>
		<div class="container">
			<h3>Lastest messages</h3>
			<div class="message" v-for="message in messages">
				<p>
					<b v-if="message.username == username">Me</b>
					<b v-else="">[[message.username]]</b> at [[message.timestamp]]
					<button v-if="message.username == username" @click="deleteMessage(message.id)">Eliminar</button>
				</p>
				<img :src="message.image" alt="Image here >.<" height="64">
				<hr>
			</div>
		</div>
	<input type="file" @change="uploadImage" name="image" id="image" accept="image/*">
	</div>

	<hr>
	<h2>Users </h2>
	{% for user in users %}
		{{ user.username }} | {{ user.last_login }}
	{% endfor %}
{% endblock %}

{% block scripts %}
	<script>
        let chatapp = new Vue({
            el: '#chatapp',
            delimiters: ['[[', ']]'],
            data() {
                return {
                    messages: {},
                    username: '{{ request.user.username }}',
                    user: {{ request.user.id }}
                }
            },
            mounted() {
                this.loadMessages()
            },
            methods: {
                loadMessages() {
                    let self = this;
                    axios.get('{% url 'chat_api:list-create-message' %}')
                        .then(function (response) {
                            self.messages = response.data
                            self.messages.forEach(function (value, index) {
                                self.messages[index].timestamp = new Date(self.messages[index].timestamp).toLocaleString()
                            });
                        })
                },
                uploadImage(e) {
                    let img = e.target.files[0]
                    let fd = new FormData()
                    let self = this;
                    fd.append('image', img)
                    fd.append('user', this.user)
                    axios.post('{% url 'chat_api:list-create-message' %}', fd)
                        .then(response => {
                            console.log(self.messages, response.data)
							response.data.timestamp = new Date(response.data.timestamp).toLocaleString()
                            self.messages.push(response.data)
                        })
                },
                deleteMessage(id) {
                    let self = this;
                    axios.delete('{% url 'chat_api:delete-message' %}', {
                        params: {detalle: id}
                    })
                        .then(response => {
                            self.messages = self.messages.filter(function (value, index, arr) {
                                return value.id != id
                            });
                        })
                },
            }
        });
	</script>
{% endblock %}