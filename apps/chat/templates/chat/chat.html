{% extends 'base.html' %}
{% block title %}
	Login |
{% endblock %}
{% block content %}
	<h1>Welcome!</h1>
	<hr>
	<div id="chatapp">
		<h2>Chat</h2>
		<h3>Lastest messages</h3>
		<div class="container">

			<div class="message" v-for="message in messages">
				<p>
					<b v-if="message.username == username">Me</b>
					<b v-else="">[[message.username]]</b> at [[message.timestamp]]
					<button v-if="message.username == username" @click="deleteMessage(message.id)">Eliminar</button>
				</p>
				<img :src="message.image" alt="Image here >.<" height="64">
				<hr>
			</div>
		</div>
		<input type="file" @change="uploadImage" name="image" id="image" accept="image/*">
	</div>

	<hr>
	<h2>Users </h2>
	{% for user in users %}
		{{ user.username }} | {{ user.last_login }}
	{% endfor %}
{% endblock %}

{% block scripts %}
	<script>
        let chatapp = new Vue({
            el: '#chatapp',
            delimiters: ['[[', ']]'],
            data() {
                return {
                    messages: {},
                    username: '{{ request.user.username }}',
                    user: {{ request.user.id }},
                    chatSocket: new WebSocket(
                        'ws://' + window.location.host + '/ws/chat/' + '{{ roomName }}' + '/'
                    )
                }
            },
            mounted() {
                this.webSocketConfiguration()
                this.loadMessages()

            },
            methods: {
                loadMessages() {
                    let self = this;
                    axios.get('{% url 'chat_api:list-create-message' %}')
                        .then(function (response) {
                            self.messages = response.data
                            self.messages.forEach(function (value, index) {
                                self.messages[index].timestamp = new Date(self.messages[index].timestamp).toLocaleString()
                            });
                            self.scrollToElement()
                        })
                },
                uploadImage(e) {
                    let img = e.target.files[0]
                    let fd = new FormData()
                    let self = this;
                    fd.append('image', img)
                    fd.append('user', this.user)
                    axios.post('{% url 'chat_api:list-create-message' %}', fd)
                        .then(response => {
                            self.chatSocket.send(JSON.stringify({
                                'id': response.data.id,
                                'user': response.data.user,
                                'username': response.data.username,
                                'image': response.data.image,
                                'timestamp': response.data.timestamp,
                            }))
                        })
                },
                deleteMessage(id) {
                    let self = this;
                    axios.delete('{% url 'chat_api:delete-message' %}', {
                        params: {detalle: id}
                    })
                        .then(response => {
                            self.messages = self.messages.filter(function (value, index, arr) {
                                return value.id != id
                            });
                        })
                },
                scrollToElement() {
                    let container = this.$el.querySelector(".container");
                    container.scrollTop = container.scrollHeight;

                    if (container) {
                        container.scrollIntoView({behavior: 'smooth'});
                    }
                },
                webSocketConfiguration() {
                    let self = this
                    //Capturar los mensajes
                    this.chatSocket.onmessage = function (e) {
                        const data = JSON.parse(e.data);
                        console.log(data)
                        data.timestamp = new Date(data.timestamp).toLocaleString()
                        self.messages.push(data)
                    }
                    this.chatSocket.onclose = function (e) {
                        console.error('Chat socket closed unexpectedly')
                    }
                },
            }
        });
	</script>
{% endblock %}